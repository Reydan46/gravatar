# Gravatar-совместимый сервис аватаров

Это приложение представляет собой локальный Gravatar-совместимый сервис для генерации и хранения аватаров пользователей.
Он позволяет получать аватары по MD5/SHA256 хешу email, синхронизировать их из Active Directory (LDAP) и поддерживает
стандартные параметры Gravatar API.

---

## Основные возможности

- **Gravatar API-совместимость**: Поддержка эндпоинта `/avatar/{hash}` и стандартных параметров (`s`, `d`, `f`, `r`,
  `o`).
- **Синхронизация с LDAP**: Автоматическая загрузка и обновление аватаров (`thumbnailPhoto`) из Active Directory.
- **Генерация аватаров**: Поддержка стандартных "дефолтных" аватаров, таких как `monsterid`, `wavatar`, `retro`,
  `identicon` и др.
- **Web-интерфейс**:
    - **/logs**: Просмотр логов работы сервиса в реальном времени с фильтрацией и поиском.
    - **/conf**: Управление пользователями, настройками LDAP, SAML и основным паролем (passphrase) без перезапуска
      сервиса.
    - **/gallery**: Галерея всех синхронизированных аватаров с поиском, фильтрацией и сортировкой.
- **Безопасность**:
    - Аутентификация для web-интерфейса на основе JWT.
    - Шифрование учетных данных и конфигурации при передаче (RSA + AES).
    - Защита от подбора пароля.
    - Поддержка SSO-аутентификации через SAML 2.0.
- **Гибкая настройка**: Все основные параметры (LDAP, пользователи, SAML) управляются через единый файл `settings.yml`.

---

## Быстрый старт

1. **Настройте окружение**:
    - Скопируйте файл `.env.example` в `.env` и отредактируйте его. Ключевой параметр — `DATA_PATH`, который
      указывает на директорию для хранения данных приложения. Подробное описание всех переменных находится внутри файла
      `.env.example`.
    - Скопируйте `settings.yml.example` в папку, указанную в `DATA_PATH`, и переименуйте его в `settings.yml`. Этот файл
      содержит все основные настройки сервиса. Описание параметров находится внутри `settings.yml.example`.

2. **Запустите сервис**:
   ```bash
   docker compose up -d --build
   ```

3. **Создайте пользователя для Web-интерфейса**:
    - Выполните команду для генерации хеша пароля:
      ```bash
      docker compose exec gravatar python -m utils.password_utils
      ```
    - Введите и повторите пароль. Скопируйте полученный хеш и добавьте его вместе с именем пользователя и правами
      доступа в `settings.yml` в секцию `users`.

4. **Используйте сервис**:
    - Web-интерфейс для логов: `http://localhost:8999/logs`
    - Web-интерфейс для настроек: `http://localhost:8999/conf`
    - Web-интерфейс галереи: `http://localhost:8999/gallery`
    - API-эндпоинт для получения аватара: `http://localhost:8999/avatar/{hash}`

---

## Синхронизация аватаров из Active Directory

Сервис может автоматически загружать фотографии пользователей (`thumbnailPhoto`) из LDAP и делать их доступными по хешу
email.

### 1. Настройка

Для работы синхронизации необходимо корректно заполнить секцию `ldap_options` в файле `settings.yml` или через
web-интерфейс на странице `/conf`.

- **`LDAP_SERVER`**: Адрес вашего контроллера домена (например, `dc.example.com`).
- **`LDAP_USERNAME`**: Имя пользователя для подключения к LDAP. Это может быть как `user@example.com` (User Principal
  Name), так и `CN=ServiceUser,OU=Users,DC=example,DC=com` (Distinguished Name). У этой учетной записи должны быть права
  на чтение атрибутов пользователей.
- **`LDAP_PASSWORD`**: Пароль для указанного пользователя.
- **`LDAP_SEARCH_BASE`**: Distinguished Name контейнера или организационной единицы (OU), в которой будет производиться
  поиск пользователей (например, `OU=Users,DC=example,DC=com`).

После внесения изменений в web-интерфейсе, нажмите кнопку "Проверить", чтобы убедиться в корректности настроек.

### 2. Запуск синхронизации

Синхронизацию можно запустить двумя способами:

- **Через web-интерфейс**: На странице `/conf` нажмите кнопку "Синхронизировать". Процесс будет отображаться в модальном
  окне в реальном времени.
- **Через API-запрос**: Отправьте POST-запрос на эндпоинт `/avatar/sync`, передав `passphrase` из вашего `settings.yml`
  в заголовке `Authorization`.

**Пример запроса с помощью `curl`:**

```bash
# Замените your_secret_passphrase_here на значение passphrase из settings.yml
curl -X POST http://localhost:8999/avatar/sync \
  -H "Authorization: Bearer your_secret_passphrase_here" \
  --no-buffer
```

- Опция `--no-buffer` в `curl` позволяет получать ответ в потоковом режиме (Server-Sent Events) и видеть прогресс
  выполнения в консоли.

### 3. Автоматизация через cron

Для регулярного обновления аватаров можно добавить задание в `cron` на сервере, где запущен Docker.

1. Откройте редактор `crontab` командой `crontab -e`.
2. Добавьте строку, указав ваше расписание и `passphrase`.

**Пример для запуска синхронизации каждый день в 3:00 ночи:**

```cron
# Запускать синхронизацию аватаров каждый день в 3:00.
# Вывод перенаправляется в /dev/null, чтобы избежать отправки email от cron.
0 3 * * * /usr/bin/curl -s -X POST http://localhost:8999/avatar/sync -H "Authorization: Bearer your_secret_passphrase_here" > /dev/null 2>&1
```

- Обязательно замените `your_secret_passphrase_here` на ваш реальный `passphrase`.
- Путь к `curl` (`/usr/bin/curl`) может отличаться в вашей системе. Проверить его можно командой `which curl`.
- `-s` (silent) подавляет вывод прогресса `curl`, что полезно для `cron`.

---

## Конфигурация

Все настройки приложения разделены на два файла:

- **`.env.local`**: Определяет переменные окружения для Docker, такие как порты, пути и количество воркеров. За основу
  возьмите `.env.example`.
- **`settings.yml`**: Основной файл конфигурации приложения, где настраиваются пользователи, LDAP, SAML и passphrase. За
  основу возьмите `settings.yml.example`.

Изменения в `settings.yml` применяются "на лету" через web-интерфейс и не требуют перезапуска сервиса.